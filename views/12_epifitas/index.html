{{extend 'layout.html'}}
{{block head}}
<style type="text/css">

    .Tabla .string
    {
        margin-right: 0.5cm;
        width: 2cm;
        text-align: center;
    }
    
    .Tabla .generic-widget
    {
    	margin-right: 2cm;
        width: 4.4cm;
    }
    
    .FlotaIzquierda
    {
        float: left;
    }

    .Centrar
    {
        text-align: center;
    }

</style>
{{end}}
{{#=response.toolbar()}}

<form action="" enctype="multipart/form-data" method="post">
    <input type="hidden" name="_formname" value="formaEpifitasHTML"/>
    <fieldset>
        <legend>
            Información de epífitas
        </legend>
        <table class="Tabla">
            <tr>
                <td>
                    <div>
                        <label for="tabla_conglomerado_muestra_id">Conglomerado</label>
                    </div>
                    <div>
                        <!--este campo sólo sirve para encontrar
                        con AJAX los sitios existentes asociados al conglomerado
                        elegido, al enviar la forma al controlador, se utilizará
                        para guardar el registro de la cámara, únicamente el id
                        del sitio (de la dropdown generada mediante AJAX)-->
                        <select class="generic-widget obligatorio" name="conglomerado_muestra_id" id="tabla_conglomerado_muestra_id">
                            <option value=""/>
                            {{for conglomerado in listaConglomerado:}}
                                <option value="{{=conglomerado.id}}">
                                    {{=conglomerado.nombre}}
                                </option>
                            {{pass}}
                        </select>
                    </div>
                </td>                
                <td>
                    <div>
                        <label for="tabla_sitio_muestra_id">Sitio</label>
                    </div>
                    <!-- El ID es para cambiar la lista de sitios asociados a un conglomerado dinámicamente, utilizando AJAX-->
                    <div id="shadow_clone">
                        <select class="generic-widget" name="sitio_muestra_id" id="tabla_sitio_muestra_id">
                            <option value=""/>
                        </select>
                    </div>
                </td>
            </tr>
        </table>
        <hr/>
        <table>
            <tr>
                <th>Tipo</th>
                <th>Evidencia</th>
            </tr>
            <tr>
                <td>
                    <label for="tabla_helechos_observados">Helechos</label>
                </td>
                <td class="Centrar">
                    <input class="boolean" name="helechos_observados" id="tabla_helechos_observados" type="checkbox" value="on"/>
                </td>
            </tr>
            <tr>
                <td>
                    <label for="tabla_orquideas_observadas">Orquídeas</label>
                </td>
                <td class="Centrar">
                    <input class="boolean" name="orquideas_observadas" id="tabla_orquideas_observadas" type="checkbox" value="on"/>
                </td>
            </tr>
            <tr>
                <td>
                    <label for="tabla_musgos_observados">Musgos</label>
                </td>
                <td class="Centrar">
                    <input class="boolean" name="musgos_observados" id="tabla_musgos_observados" type="checkbox" value="on"/>
                </td>
            </tr>
            <tr>
                <td>
                    <label for="tabla_liquenes_observados">Líquenes</label>
                </td>
                <td class="Centrar">
                    <input class="boolean" name="liquenes_observados" id="tabla_liquenes_observados" type="checkbox" value="on"/>
                </td>
            </tr>
            <tr>
                <td>
                    <label for="tabla_cactaceas_observadas">Cactáceas</label>
                </td>
                <td class="Centrar">
                    <input class="boolean" name="cactaceas_observadas" id="tabla_cactaceas_observadas" type="checkbox" value="on"/>
                </td>
            </tr>
            <tr>
                <td>
                    <label for="tabla_bromeliaceas_observadas">Bromeliáceas</label>
                </td>
                <td class="Centrar">
                    <input class="boolean" name="bromeliaceas_observadas" id="tabla_bromeliaceas_observadas" type="checkbox" value="on"/>
                </td>
            </tr>
            <tr>
                <td>
                    <label for="tabla_otras_observadas">Otras</label>
                </td>
                <td class="Centrar">
                    <input class="boolean" name="otras_observadas" id="tabla_otras_observadas" type="checkbox" value="on"/>
                </td>
                <td>
                    <div class="Nombre">
                        <label for="tabla_nombre_otras">Nombre</label>
                    </div>
                </td>
                <td>
                    <div class="Nombre">
                        <input class="string" name="nombre_otras" id="tabla_nombre_otras" type="text" value=""/>
                    </div>
                </td>
            </tr>
        </table>
    <hr/>
    </fieldset>
    <input type="submit" value="Enviar" class="btn FlotaIzquierda"/>
</form>

{{#=BEAUTIFY(request.vars)}}
<script>

    $(document).ready
    (
        function()
        {
           /* Cuando el documento se carga, el campo Nombre está escondido */
           $('#tabla_otras_observadas').prop('checked', false);
           $('.Nombre').hide();
        }
    )
    
    /* Cuando se selecciona la opción "Otras" aparece el campo Nombre */
    
    $('#tabla_otras_observadas').change
    (
        function()
        {
            if($(this).prop('checked'))
            {
                $('.Nombre').fadeIn();
            }
            else
                $('.Nombre').fadeOut();
        }
    )

    //AJAX para llenar la combobox con los sitios existentes al elegir el conglomerado
    $('#tabla_conglomerado_muestra_id').change
    (
        function()
        {
            $('#tabla_sitio_muestra_id').remove();

            //ajax es una función de Web2py que simplifica la función homónima de JQuery
            //recibe el URL destino, los nombres de los campos que se enviarán y el ID
            // del elemento donde se insertará la respuesta
            ajax("{{=URL('asignarSitios')}}", ['conglomerado_muestra_id'], 'shadow_clone');
        }
       )

    //AJAX para evitar que se envíe la información de los sitios correspondientes
    //a un sitio más de una vez:
    $('#shadow_clone').on('change','#tabla_sitio_muestra_id',function (){
        $.ajax
        (
        {
            type: "POST",
            data: $('#tabla_sitio_muestra_id').serialize(),
            url: "{{=URL('informacionEpifitasExistente')}}",
                success: function(resultado)
                {
                    //alert(resultado);
                    if(resultado>0)
                    {
                        alert('La información de epífitas ya ha sido insertada para el sitio seleccionado');
                        $('#tabla_sitio_muestra_id').val("");
                    }
                }
            }
            );
        }
        );

    //Validando, para ello utilizamos la clase "obligatorio":
    $('form').submit
    (
         function()
         {
            flag =true;
            campos=$('.obligatorio');
            campos.each(function() 
            {
                if(!$(this).val())
                {
                    flag = false;
                }
            }
            );

            //Validando que se escriba el nombre de la epífita si la opción "Otras"
            // es seleccionada

            faltanNombres = false;
            if($('#tabla_otras_observadas').prop('checked'))
            {
                if(!$(tabla_nombre_otras).val())
                {
                    //alert('Favor de introducir el nombre de las epífitas observadas');
                    flag=false;
                    faltanNombres=true;
                }
            }

            //Sin embargo, como el campo de "sitio_muestra_id" es generado por
            //medio de AJAX; no entra en la validación anterior. Lo tenemos que
            //validar aparte:
            if(!$('#shadow_clone').find('select:first').val())
            {
                flag = false;
                //alert('Falta llenar el sitio');
            }

            if(!flag)
            {
                if(faltanNombres)
                    alert('Favor de escribir el nombre de la epífita que no se encuentra en la lista');
                else
                    alert('Faltó llenar un campo');
                return false;
            }

        }
    )
    
</script>
