{{extend 'layout.html'}}
{{block head}}
<style type="text/css">

    .Tabla .generic-widget
    {
    	margin-right: 2cm;
        width: 4.4cm;
    }
    .Tabla .string, .Tabla .date, .Tabla .time
    {
    	margin-right: 2cm;
        width: 4cm;
    }
    
    .Centrar
    {
        text-align: center;
    }
 
    #enviar
    {
        float: left;
    }
</style>
{{end}}

<form action="" enctype="multipart/form-data" method="post" id="forma">
    <input type="hidden"  name="_formname" value="formaPuntoConteoHTML"/>
	<fieldset>
		<legend>
		Punto de conteo de aves
		</legend>
		<table class="Tabla">
			<tr>
				<td>
					<div>
						<label for="tabla_conglomerado_muestra_id">Conglomerado</label>
					</div>
					<div>
						<select class="generic-widget obligatorio" name="conglomerado_muestra_id" id="tabla_conglomerado_muestra_id">
							<option value=""/>
							{{for conglomerado in listaConglomerado:}}
								<option value="{{=conglomerado.id}}">
									{{=conglomerado.nombre}}
								</option>
							{{pass}}
						</select>
					</div>
				</td>
                <td>
                    <div>
                        <label for="tabla_sitio_muestra_id">Sitio</label>
                    </div>
                    <!-- El ID es para cambiar la lista de sitios asociados a un conglomerado dinámicamente, utilizando AJAX-->
                    <div id="shadow_clone">
                        <select class="generic-widget" name="sitio_muestra_id" id="tabla_sitio_muestra_id">
                            <option value=""/>
                        </select>
                    </div>
                </td>
				<td>
					<div>
						<label for="tabla_tecnico">Técnico</label>
					</div>
					<div>
						<input class="string obligatorio" name="tecnico" id="tabla_tecnico" type="text" value=""/>
					</div>
				</td>
                <td>
                </td>
			</tr>
			<tr>
				<td>
					<div>
						<label for="tabla_fecha">Fecha</label>
					</div>
					<div>
						<input class="date obligatorio" name="fecha" id="tabla_fecha" type="text" value=""/>
					</div>
				</td>
				<td>
					<div>
						<label for="tabla_hora_inicio">Hora inicio (24 horas)</label>
					</div>
					<div>
						<input class="time obligatorio" name="hora_inicio" id="tabla_hora_inicio" type="text" value=""/>
					</div>
				</td>
				<td>
					<div>
						<label for="tabla_hora_termino">Hora término (24 horas)</label>
					</div>
					<div>
						<input class="time obligatorio" name="hora_termino" id="tabla_hora_termino" type="text" value=""/>
					</div>
				</td>
				<td>
				 	<div>
						<label for="tabla_condiciones_ambientales">Condiciones ambientales</label>
					</div>
					<div>
                    <select class="generic-widget obligatorio" name="condiciones_ambientales" id="tabla_condiciones_ambientales">
                        <option value=""/>
                        {{for condicion in listaCondicionesAmbientales:}}
                            <option value="{{=condicion.nombre}}">
                                {{=condicion.nombre}}
                            </option>
                        {{pass}}
                    </select>
                    </div>
                </td>
			</tr>
		</table>
	</fieldset>
    <fieldset>
        <label for="tabla_comentario">Observaciones</label>
        <textarea class="text" cols="40" id="tabla_comentario" name="comentario" rows="5"></textarea>
    </fieldset>
    <input type="submit" value="Enviar" class="btn FlotaIzquierda"/>
</form>

<script>

	//AJAX para llenar sitios
    $('#tabla_conglomerado_muestra_id').change
    (
        function()
        {
            $('#tabla_sitio_muestra_id').remove();

            //ajax es una función de Web2py que simplifica la función homónima de JQuery
            //recibe el URL destino, los nombres de los campos que se enviarán y el ID
            // del elemento donde se insertará la respuesta
            ajax("{{=URL('asignarSitios')}}", ['conglomerado_muestra_id'], 'shadow_clone');
        }
    )

    //AJAX para evitar que se envíe la información del punto de conteo
    //correspondiente a un sitio más de una vez:
    $('#shadow_clone').on('change', '#tabla_sitio_muestra_id', function ()
    {
        $.ajax
        (
        {
            type: "POST",
            data: $('#tabla_sitio_muestra_id').serialize(),
            url: "{{=URL('puntoConteoExistente')}}",
            success: function(resultado)
                {
                    //alert(resultado);
                    if(resultado>=1)
                    {
                        alert('Ya ha sido declarado un punto de conteo de aves en este sitio');
                        $('#tabla_sitio_muestra_id').val("");
                    }
                }
        }
        );
    }
    );

	//Validando, para ello utilizamos la clase "obligatorio":
   	$('form').submit
   	(
   		function()
   		{
   			flag =true;
   			campos=$('.obligatorio');
   			campos.each(function() 
   			{
  				if(!$(this).val())
  				{
  					 flag = false;
  				}
            });

            //Validando que la fecha esté en formato adecuado para que Web2py no tenga problemas:
            var fechaReg = /^\d{4}\-(\d{2})-(\d{2})$/;
            campos_fecha=$('.date');
            flag_m = true;
            campos_fecha.each(function(){   
                if(!fechaReg.test($(this).val()))
                {
                    flag_m = false;
                }
                //Revisando que el mes y el día estén en un rango aceptable:
                else
                {
                    //match contiene como primer elemento, el match de toda la regex, y como elementos
                    //posteriores, el match de los elementos en paréntesis de la regex (en órden).
                    var match = fechaReg.exec($(this).val());
                    //alert(match);

                    //Validando que el mes se encuentre en un rango aceptable:
                    if(match[1]<1 || match[1]>12)
                    {
                        //alert('El mes es incorrecto');
                        //alert(match[1]);
                        flag_m = false;
                    }

                    //Validando que el día se encuentre en un rango aceptable:
                    if(match[2]<1 || match[2]>31)
                    {
                        //alert('El día es incorrecto');
                        //alert(match[2]);
                        flag_m = false;
                    }
                }
            });

            //Sin embargo, como el campo de "sitio_muestra_id" es generado por
            //medio de AJAX; no entra en la validación anterior. Lo tenemos que
            //validar aparte:
            if(!$('#shadow_clone').find('select:first').val())
            {
                flag = false;
                //alert('Falta llenar el sitio');
            }
        	           
			if(!flag)
            {
                alert('Faltó llenar algún campo obligatorio');
            	return false;
			}
            else if(!flag_m){
                alert('El formato de fecha es aaaa-mm-dd');
                return false;
            }
            //Validando que la hora de inicio sea menor que la de término
            else
            {
                var hora_inicio = $('#tabla_hora_inicio').val();
                var hora_termino = $('#tabla_hora_termino').val();

                //Usando el órden lexicográfico natural de strings para comparar fechas:
                if(hora_inicio>hora_termino)
                {
                    alert('La hora de inicio debe ser menor a la hora de término');
                    return false;
                }
            }
   		}

   	)
</script>